name: Funda CD (Deploy)

on:
  workflow_run:
    workflows: ['Funda CI (Build & Push)']
    types:
      - completed
    branches:
      - main

jobs:
  deploy:
    # CI 워크플로우가 성공적으로 끝났을 때만 실행
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: deploy to NCP Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SERVER_SSH_PORT }}
          script: |
            APP_DIR=~/web21-funda
            cd $APP_DIR

            # 1. 최신 코드 가져오기 (배포 설정 파일 갱신)
            git pull origin main

            # 2. .env 파일 생성 (루트 디렉토리)
            printf "NCR_REGISTRY=%s\nDB_USER=%s\nDB_PASSWORD=%s\nGRAFANA_ADMIN_PASSWORD=%s\nMAIL_USER=%s\nMAIL_PASS=%s\nGRAFANA_ROOT_URL=%s\n" \
            "${{ secrets.NCR_REGISTRY }}" \
            "${{ secrets.DB_USER }}" \
            "${{ secrets.DB_PASSWORD }}" \
            "${{ secrets.GRAFANA_ADMIN_PASSWORD }}" \
            "${{ secrets.MAIL_USER }}" \
            "${{ secrets.MAIL_PASS }}" \
            "${{ secrets.GRAFANA_ROOT_URL }}" > .env

            # docker compose 변수 치환이 확실히 동작하도록 환경 변수를 내보냄
            export NCR_REGISTRY="${{ secrets.NCR_REGISTRY }}"
            export DB_USER="${{ secrets.DB_USER }}"
            export DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
            export GRAFANA_ADMIN_PASSWORD="${{ secrets.GRAFANA_ADMIN_PASSWORD }}"
            export MAIL_USER="${{ secrets.MAIL_USER }}"
            export MAIL_PASS="${{ secrets.MAIL_PASS }}"
            export GRAFANA_ROOT_URL="${{ secrets.GRAFANA_ROOT_URL }}"

            # 3. BE 전용 환경 변수 주입
            mkdir -p apps/backend
            printf '%s' "${{ secrets.ENV_BE_PROD }}" > apps/backend/.env.production

            # 4. NCR 로그인
            echo "${{ secrets.NCP_SECRET_KEY }}" | docker login ${{ secrets.NCR_REGISTRY }} -u ${{ secrets.NCP_ACCESS_KEY }} --password-stdin

            # 5. 네트워크 및 공통 설정 준비
            docker network inspect funda-network >/dev/null 2>&1 || docker network create funda-network

            # 6. 실행 (애플리케이션 + 모니터링)
            APP_COMPOSE=docker/production/docker-compose.deploy.yml
            MONITOR_COMPOSE=docker/monitoring/docker-compose.monitoring.production.yml

            docker compose --env-file .env -f $APP_COMPOSE pull
            docker compose --env-file .env -f $MONITOR_COMPOSE pull

            docker compose --env-file .env -f $APP_COMPOSE up -d
            docker compose --env-file .env -f $MONITOR_COMPOSE up -d

            # 7. DB 마이그레이션
            docker compose --env-file .env -f $APP_COMPOSE exec -T backend \
              node ./node_modules/typeorm/cli.js -d dist/config/typeorm.data-source.js migration:run

            # 8. 정리
            docker image prune -f
